<?php

namespace App\Presenters\PanelModule;

use App\Forms\Panel\SignInForm;
use App\Model\DI\GoogleAnalytics;
use App\Model\Security\Auth\PluginAuthenticator;
use App\Model\Security\Exceptions\AuthException;
use App\Model\SettingsRepository;
use App\Presenters\PanelBasePresenter;

use Nette\Application\AbortException;
use Nette\Application\UI\Form;

/**
 * Class LoginPresenter
 * @package App\Presenters\PanelModule
 */
class LoginPresenter extends PanelBasePresenter
{
    private PluginAuthenticator $pluginAuthenticator;
    private SettingsRepository $settingsRepository;

    /**
     * LoginPresenter constructor.
     * @param PluginAuthenticator $pluginAuthenticator
     * @param SettingsRepository $settingsRepository
     * @param GoogleAnalytics $googleAnalytics
     */
    public function __construct(PluginAuthenticator $pluginAuthenticator, SettingsRepository $settingsRepository, GoogleAnalytics $googleAnalytics)
    {
        parent::__construct($settingsRepository, $googleAnalytics);

        $this->pluginAuthenticator = $pluginAuthenticator;
        $this->settingsRepository = $settingsRepository;
    }

    public function startup()
    {
        parent::startup(); // TODO: Change the autogenerated stub
    }

    /**
     * @throws AbortException
     */
    public function renderMain() {
        if((bool)$this->pluginAuthenticator->getUser()) {
            $this->redirect('Main:home');
        }
    }

    /**
     * @throws AbortException
     */
    public function actionLogout() {
        try {
            $this->pluginAuthenticator->logout();
            $this->flashMessage('Byl jsi odhlášen, pro další manipulaci s panelem se přihlaš!', 'dark-green');
            $this->redirect('Login:main');
        } catch (AuthException $e) {
            $this->flashMessage($e->getMessage(), 'error');
        }
    }

    public function createComponentSignInForm(): Form {
        return (new SignInForm($this->pluginAuthenticator, $this))->create();
    }
}